<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zonebrite Solutions - Monthly Maintenance Report Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">ZONEBRITE SOLUTIONS</div>
            <div class="tagline">Protecting What Matters Most</div>
            <div class="page-title">Monthly Maintenance Report Generator</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <strong>Last Saved:</strong> <span id="lastSaved">Never</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-label">Form Progress: <span id="progressText">0%</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="save-indicator" id="saveIndicator">
                âœ“ Saved
            </div>
        </div>

        <!-- Form -->
        <form id="maintenanceForm">
            <!-- Section 1: Report Header -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">1</span>
                    Report Header
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Report Month/Year <span class="required">*</span></label>
                        <input type="month" name="reportMonth" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Report Generated Date <span class="required">*</span></label>
                        <input type="date" name="reportDate" required>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Client Business Name <span class="required">*</span></label>
                        <input type="text" name="clientName" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Property Address <span class="required">*</span></label>
                        <input type="text" name="propertyAddress" required>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Technician Name <span class="required">*</span></label>
                        <input type="text" name="technicianName" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Service Date(s) Completed <span class="required">*</span></label>
                        <input type="date" name="serviceDate" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Next Scheduled Maintenance <span class="required">*</span></label>
                        <input type="date" name="nextMaintenance" required>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
            </div>

            <!-- Section 2: System Health Overview -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">2</span>
                    System Health Overview
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Overall System Status <span class="required">*</span></label>
                        <select name="systemStatus" required>
                            <option value="">Select Status</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Needs Attention">Needs Attention</option>
                            <option value="Critical">Critical</option>
                        </select>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Network Connectivity Status <span class="required">*</span></label>
                        <select name="networkStatus" required>
                            <option value="">Select Status</option>
                            <option value="Stable">Stable</option>
                            <option value="Intermittent">Intermittent</option>
                            <option value="Issues Detected">Issues Detected</option>
                        </select>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Cameras in System <span class="required">*</span></label>
                        <input type="number" name="totalCameras" min="0" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Cameras Operational <span class="required">*</span></label>
                        <input type="number" name="camerasOperational" min="0" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Cameras Requiring Attention</label>
                        <input type="number" name="camerasAttention" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>System Uptime Percentage <span class="required">*</span></label>
                        <input type="number" name="uptime" min="0" max="100" step="0.01" required>
                        <span class="error-message">This field is required (0-100)</span>
                    </div>
                    <div class="form-group">
                        <label>Storage Days Remaining <span class="required">*</span></label>
                        <input type="number" name="storageDays" min="0" required>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Recording Storage Used <span class="required">*</span></label>
                        <div class="range-container">
                            <input type="range" name="storageUsed" min="0" max="100" value="50" required>
                            <span class="range-value"><span id="storageValue">50</span>%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Maintenance Activities Completed -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">3</span>
                    Maintenance Activities Completed
                </h2>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity1" name="activities" value="Camera lens cleaning">
                        <label for="activity1">Camera lens cleaning</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity2" name="activities" value="Camera housing inspection">
                        <label for="activity2">Camera housing inspection</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity3" name="activities" value="Camera angle/positioning verification">
                        <label for="activity3">Camera angle/positioning verification</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity4" name="activities" value="Recording quality verification">
                        <label for="activity4">Recording quality verification</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity5" name="activities" value="Playback functionality test">
                        <label for="activity5">Playback functionality test</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity6" name="activities" value="Storage device health check">
                        <label for="activity6">Storage device health check</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity7" name="activities" value="Network connection verification">
                        <label for="activity7">Network connection verification</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity8" name="activities" value="Firmware/software updates applied">
                        <label for="activity8">Firmware/software updates applied</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity9" name="activities" value="Power supply inspection">
                        <label for="activity9">Power supply inspection</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity10" name="activities" value="Cable and connection inspection">
                        <label for="activity10">Cable and connection inspection</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity11" name="activities" value="Access control system test">
                        <label for="activity11">Access control system test (if applicable)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity12" name="activities" value="Remote viewing functionality test">
                        <label for="activity12">Remote viewing functionality test</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity13" name="activities" value="Motion detection calibration">
                        <label for="activity13">Motion detection calibration</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity14" name="activities" value="Night vision verification">
                        <label for="activity14">Night vision verification</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="activity15" name="activities" value="Weatherproofing inspection">
                        <label for="activity15">Weatherproofing inspection (outdoor cameras)</label>
                    </div>
                </div>
            </div>

            <!-- Section 4: Individual Camera Status -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">4</span>
                    Individual Camera Status
                </h2>
                <div id="camerasContainer">
                    <!-- Dynamic camera entries will be added here -->
                </div>
                <button type="button" class="add-btn" onclick="addCamera()">Add Camera</button>
            </div>

            <!-- Section 5: Issues Identified & Resolved -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">5</span>
                    Issues Identified & Resolved
                </h2>
                <div id="issuesContainer">
                    <!-- Dynamic issue entries will be added here -->
                </div>
                <button type="button" class="add-btn" onclick="addIssue()">Add Issue</button>
            </div>

            <!-- Section 6: Recommendations -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">6</span>
                    Recommendations
                </h2>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Maintenance Recommendations</label>
                        <textarea name="maintenanceRec" rows="4"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Upgrade Opportunities</label>
                        <textarea name="upgradeOpp" rows="4"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>System Optimization Suggestions</label>
                        <textarea name="optimizationSug" rows="4"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estimated Cost (if applicable)</label>
                        <input type="text" name="estimatedCost" placeholder="$0.00">
                    </div>
                    <div class="form-group">
                        <label>Priority Level</label>
                        <select name="priorityLevel">
                            <option value="">Select Priority</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 7: Storage & Recording Details -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">7</span>
                    Storage & Recording Details
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Storage Capacity <span class="required">*</span></label>
                        <input type="text" name="storageCapacity" placeholder="e.g., 2TB" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Current Storage Used <span class="required">*</span></label>
                        <input type="text" name="storageCurrentlyUsed" placeholder="e.g., 1.2TB" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Recording Retention Period (days) <span class="required">*</span></label>
                        <input type="number" name="retentionPeriod" min="0" required>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Video Quality Settings <span class="required">*</span></label>
                        <select name="videoQuality" required>
                            <option value="">Select Quality</option>
                            <option value="4K">4K</option>
                            <option value="1080p">1080p</option>
                            <option value="720p">720p</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Backup Status <span class="required">*</span></label>
                        <select name="backupStatus" required>
                            <option value="">Select Status</option>
                            <option value="Active">Active</option>
                            <option value="Not Configured">Not Configured</option>
                            <option value="Failed">Failed</option>
                        </select>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
            </div>

            <!-- Section 8: System Updates -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">8</span>
                    System Updates
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Firmware Version</label>
                        <input type="text" name="firmwareVersion">
                    </div>
                    <div class="form-group">
                        <label>Current Software Version</label>
                        <input type="text" name="softwareVersion">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Updates Applied This Month</label>
                        <textarea name="updatesApplied" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Updates Recommended</label>
                        <textarea name="updatesRecommended" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 9: Summary -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">9</span>
                    Summary
                </h2>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Overall Assessment <span class="required">*</span></label>
                        <textarea name="overallAssessment" rows="4" required></textarea>
                        <span class="error-message">This field is required</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Critical Items Requiring Immediate Attention</label>
                        <textarea name="criticalItems" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Next Month's Focus Areas</label>
                        <textarea name="focusAreas" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 10: Sign-off -->
            <div class="form-section">
                <h2 class="section-title">
                    <span class="section-number">10</span>
                    Sign-off
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Technician Signature/Name <span class="required">*</span></label>
                        <input type="text" name="techSignature" required>
                        <span class="error-message">This field is required</span>
                    </div>
                    <div class="form-group">
                        <label>Client Acknowledgment Name (optional)</label>
                        <input type="text" name="clientAck">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Client Notes/Feedback (optional)</label>
                        <textarea name="clientFeedback" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="generatePDF()">Generate PDF</button>
                <button type="button" class="btn btn-secondary" onclick="saveFormData()">Save Progress</button>
                <button type="button" class="btn btn-danger" onclick="showClearConfirmation()">Clear Form</button>
            </div>
        </form>
    </div>

    <!-- Restore Session Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Restore Previous Session?</div>
            <div class="modal-body">
                We found a previously saved report. Would you like to restore it and continue where you left off?
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRestoreModal()">Start Fresh</button>
                <button class="btn btn-primary" onclick="restoreSession()">Restore</button>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div id="clearModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Clear All Data?</div>
            <div class="modal-body">
                Are you sure you want to clear all form data? This action cannot be undone.
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeClearModal()">Cancel</button>
                <button class="btn btn-danger" onclick="clearForm()">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let cameraCount = 0;
        let issueCount = 0;
        let autoSaveInterval;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="reportDate"]').value = today;

            // Calculate next maintenance date (30 days from today)
            const nextMonth = new Date();
            nextMonth.setDate(nextMonth.getDate() + 30);
            document.querySelector('[name="nextMaintenance"]').value = nextMonth.toISOString().split('T')[0];

            // Check for saved data
            if (localStorage.getItem('reportData')) {
                document.getElementById('restoreModal').style.display = 'block';
            } else {
                // Add initial camera and issue
                addCamera();
                addIssue();
            }

            // Set up auto-save
            autoSaveInterval = setInterval(autoSave, 30000); // Every 30 seconds

            // Add event listeners for auto-save on blur
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('blur', autoSave);
            });

            // Update storage slider value display
            const storageSlider = document.querySelector('[name="storageUsed"]');
            storageSlider.addEventListener('input', function() {
                document.getElementById('storageValue').textContent = this.value;
            });

            // Auto-calculate cameras requiring attention
            const totalCamerasInput = document.querySelector('[name="totalCameras"]');
            const operationalCamerasInput = document.querySelector('[name="camerasOperational"]');

            function updateCamerasAttention() {
                const total = parseInt(totalCamerasInput.value) || 0;
                const operational = parseInt(operationalCamerasInput.value) || 0;
                document.querySelector('[name="camerasAttention"]').value = Math.max(0, total - operational);
                updateProgress();
            }

            totalCamerasInput.addEventListener('input', updateCamerasAttention);
            operationalCamerasInput.addEventListener('input', updateCamerasAttention);

            // Update progress on any form change
            document.getElementById('maintenanceForm').addEventListener('input', updateProgress);
            document.getElementById('maintenanceForm').addEventListener('change', updateProgress);

            // Initial progress update
            updateProgress();
        });

        // Add Camera
        function addCamera() {
            cameraCount++;
            const container = document.getElementById('camerasContainer');
            const cameraDiv = document.createElement('div');
            cameraDiv.className = 'dynamic-item';
            cameraDiv.id = `camera-${cameraCount}`;
            cameraDiv.innerHTML = `
                <div class="dynamic-item-header">
                    <span class="item-number">Camera #${cameraCount}</span>
                    <button type="button" class="remove-btn" onclick="removeCamera(${cameraCount})">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Camera Location/Name</label>
                        <input type="text" name="camera_${cameraCount}_location">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="camera_${cameraCount}_status">
                            <option value="">Select Status</option>
                            <option value="Operational">Operational</option>
                            <option value="Needs Attention">Needs Attention</option>
                            <option value="Offline">Offline</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Issues Found (optional)</label>
                        <textarea name="camera_${cameraCount}_issues" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Actions Taken (optional)</label>
                        <textarea name="camera_${cameraCount}_actions" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Notes (optional)</label>
                        <textarea name="camera_${cameraCount}_notes" rows="2"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(cameraDiv);
            updateProgress();
        }

        // Remove Camera
        function removeCamera(id) {
            const element = document.getElementById(`camera-${id}`);
            if (element) {
                element.remove();
                updateProgress();
            }
        }

        // Add Issue
        function addIssue() {
            issueCount++;
            const container = document.getElementById('issuesContainer');
            const issueDiv = document.createElement('div');
            issueDiv.className = 'dynamic-item';
            issueDiv.id = `issue-${issueCount}`;
            issueDiv.innerHTML = `
                <div class="dynamic-item-header">
                    <span class="item-number">Issue #${issueCount}</span>
                    <button type="button" class="remove-btn" onclick="removeIssue(${issueCount})">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Severity</label>
                        <select name="issue_${issueCount}_severity">
                            <option value="">Select Severity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Parts Replaced (optional)</label>
                        <input type="text" name="issue_${issueCount}_parts">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Issue Description</label>
                        <textarea name="issue_${issueCount}_description" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Resolution</label>
                        <textarea name="issue_${issueCount}_resolution" rows="2"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(issueDiv);
            updateProgress();
        }

        // Remove Issue
        function removeIssue(id) {
            const element = document.getElementById(`issue-${id}`);
            if (element) {
                element.remove();
                updateProgress();
            }
        }

        // Update Progress
        function updateProgress() {
            const form = document.getElementById('maintenanceForm');
            const requiredFields = form.querySelectorAll('[required]');
            let filledCount = 0;

            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    // For checkboxes, check if any in the group are checked
                    const checkboxes = form.querySelectorAll('[name="' + field.name + '"]');
                    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                    if (anyChecked) filledCount++;
                } else if (field.value.trim() !== '') {
                    filledCount++;
                }
            });

            const percentage = Math.round((filledCount / requiredFields.length) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
        }

        // Save Form Data
        function saveFormData() {
            const formData = getFormData();
            localStorage.setItem('reportData', JSON.stringify(formData));
            localStorage.setItem('lastSaved', new Date().toISOString());
            updateLastSavedDisplay();
            showSaveIndicator();
        }

        // Auto-save
        function autoSave() {
            saveFormData();
        }

        // Get Form Data
        function getFormData() {
            const form = document.getElementById('maintenanceForm');
            const formData = new FormData(form);
            const data = {};

            // Get all form elements
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    // Handle multiple values (checkboxes)
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }

            // Get all checkboxes (including unchecked)
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (!data[cb.name]) {
                    data[cb.name] = [];
                }
            });

            // Store counts for dynamic sections
            data.cameraCount = cameraCount;
            data.issueCount = issueCount;

            return data;
        }

        // Set Form Data
        function setFormData(data) {
            const form = document.getElementById('maintenanceForm');

            // Restore camera and issue counts
            if (data.cameraCount) {
                for (let i = 1; i <= data.cameraCount; i++) {
                    if (data[`camera_${i}_location`] !== undefined) {
                        addCamera();
                    }
                }
            }

            if (data.issueCount) {
                for (let i = 1; i <= data.issueCount; i++) {
                    if (data[`issue_${i}_description`] !== undefined) {
                        addIssue();
                    }
                }
            }

            // Populate form fields
            for (let key in data) {
                const element = form.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        const checkboxes = form.querySelectorAll(`[name="${key}"]`);
                        const values = Array.isArray(data[key]) ? data[key] : [data[key]];
                        checkboxes.forEach(cb => {
                            cb.checked = values.includes(cb.value);
                        });
                    } else {
                        element.value = data[key];
                    }
                }
            }

            updateProgress();
        }

        // Show Save Indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Update Last Saved Display
        function updateLastSavedDisplay() {
            const lastSaved = localStorage.getItem('lastSaved');
            if (lastSaved) {
                const date = new Date(lastSaved);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000); // seconds

                let displayText;
                if (diff < 60) {
                    displayText = 'Just now';
                } else if (diff < 3600) {
                    const minutes = Math.floor(diff / 60);
                    displayText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                } else {
                    displayText = date.toLocaleString();
                }

                document.getElementById('lastSaved').textContent = displayText;
            }
        }

        // Update last saved display every minute
        setInterval(updateLastSavedDisplay, 60000);

        // Restore Session
        function restoreSession() {
            const savedData = localStorage.getItem('reportData');
            if (savedData) {
                const data = JSON.parse(savedData);
                setFormData(data);
                updateLastSavedDisplay();
            }
            closeRestoreModal();
        }

        // Close Restore Modal
        function closeRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
            // Add initial camera and issue if starting fresh
            if (cameraCount === 0) addCamera();
            if (issueCount === 0) addIssue();
        }

        // Show Clear Confirmation
        function showClearConfirmation() {
            document.getElementById('clearModal').style.display = 'block';
        }

        // Close Clear Modal
        function closeClearModal() {
            document.getElementById('clearModal').style.display = 'none';
        }

        // Clear Form
        function clearForm() {
            if (confirm('Are you absolutely sure? This will delete all data permanently.')) {
                document.getElementById('maintenanceForm').reset();
                localStorage.removeItem('reportData');
                localStorage.removeItem('lastSaved');

                // Clear dynamic sections
                document.getElementById('camerasContainer').innerHTML = '';
                document.getElementById('issuesContainer').innerHTML = '';
                cameraCount = 0;
                issueCount = 0;

                // Add initial items
                addCamera();
                addIssue();

                // Reset displays
                document.getElementById('lastSaved').textContent = 'Never';
                updateProgress();
                closeClearModal();
            }
        }

        // Validate Form
        function validateForm() {
            const form = document.getElementById('maintenanceForm');
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields (marked with *)');
                // Scroll to first error
                const firstError = form.querySelector('.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return isValid;
        }

        // Generate PDF
        function generatePDF() {
            if (!validateForm()) {
                return;
            }

            // Show loading indicator
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Generating PDF<span class="spinner"></span>';
            btn.disabled = true;

            try {
                const formData = getFormData();

                // Generate filename
                const clientNameClean = (formData.clientName || 'Client').replace(/[^a-zA-Z0-9]/g, '');
                let monthYear = 'Report';
                if (formData.reportMonth) {
                    const date = new Date(formData.reportMonth + '-01');
                    monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }).replace(' ', '');
                }
                const filename = `${clientNameClean}_MaintenanceReport_${monthYear}.pdf`;

                // Create HTML content for PDF
                const pdfContent = createPDFTemplate(formData);

                // Configure html2pdf options
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Generate PDF
                html2pdf().set(opt).from(pdfContent).save().then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('PDF generated successfully!');
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please check the console for details.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please check the console for details.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Create PDF HTML Template with vanilla CSS styling
        function createPDFTemplate(data) {
            const reportPeriod = data.reportMonth ? new Date(data.reportMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'N/A';

            // Get activities array
            const activities = data.activities ? (Array.isArray(data.activities) ? data.activities : [data.activities]) : [];

            // Get status badge class
            const getStatusClass = (status) => {
                const statusMap = {
                    'Excellent': 'pdf-badge-excellent',
                    'Good': 'pdf-badge-good',
                    'Operational': 'pdf-badge-operational',
                    'Stable': 'pdf-badge-stable',
                    'Active': 'pdf-badge-active',
                    'Needs Attention': 'pdf-badge-needs-attention',
                    'Intermittent': 'pdf-badge-intermittent',
                    'Critical': 'pdf-badge-critical',
                    'Offline': 'pdf-badge-offline',
                    'Issues Detected': 'pdf-badge-issues-detected',
                    'Failed': 'pdf-badge-failed',
                    'Not Configured': 'pdf-badge-not-configured'
                };
                return 'pdf-badge ' + (statusMap[status] || '');
            };

            const getSeverityClass = (severity) => {
                const severityMap = {
                    'Critical': 'pdf-badge-severity-critical',
                    'High': 'pdf-badge-severity-high',
                    'Medium': 'pdf-badge-severity-medium',
                    'Low': 'pdf-badge-severity-low'
                };
                return 'pdf-badge ' + (severityMap[severity] || '');
            };

            // Build cameras HTML
            let camerasHTML = '';
            let cameraFound = false;
            for (let i = 1; i <= data.cameraCount; i++) {
                const location = data[`camera_${i}_location`];
                if (location) {
                    cameraFound = true;
                    const status = data[`camera_${i}_status`];
                    const issues = data[`camera_${i}_issues`];
                    const actions = data[`camera_${i}_actions`];
                    const notes = data[`camera_${i}_notes`];

                    camerasHTML += `
                        <div class="pdf-camera-item">
                            <div class="pdf-camera-header">
                                <h4 class="pdf-camera-title">ðŸ“· Camera #${i}: ${location}</h4>
                                ${status ? `<span class="${getStatusClass(status)}">${status}</span>` : ''}
                            </div>
                            ${issues ? `<div class="pdf-info-row"><span class="pdf-info-label">Issues:</span> <span class="pdf-info-value">${issues}</span></div>` : ''}
                            ${actions ? `<div class="pdf-info-row"><span class="pdf-info-label">Actions:</span> <span class="pdf-info-value">${actions}</span></div>` : ''}
                            ${notes ? `<div class="pdf-info-row"><span class="pdf-info-label">Notes:</span> <span class="pdf-info-value">${notes}</span></div>` : ''}
                        </div>
                    `;
                }
            }
            if (!cameraFound) {
                camerasHTML = '<p class="pdf-no-data">No camera details recorded</p>';
            }

            // Build issues HTML
            let issuesHTML = '';
            let issueFound = false;
            for (let i = 1; i <= data.issueCount; i++) {
                const description = data[`issue_${i}_description`];
                if (description) {
                    issueFound = true;
                    const severity = data[`issue_${i}_severity`];
                    const resolution = data[`issue_${i}_resolution`];
                    const parts = data[`issue_${i}_parts`];

                    issuesHTML += `
                        <div class="pdf-issue-item">
                            <div class="pdf-issue-header">
                                <h4 class="pdf-issue-title">âš  Issue #${i}</h4>
                                ${severity ? `<span class="${getSeverityClass(severity)}">${severity}</span>` : ''}
                            </div>
                            <div class="pdf-info-row"><span class="pdf-info-label">Description:</span> <span class="pdf-info-value">${description}</span></div>
                            ${resolution ? `<div class="pdf-info-row"><span class="pdf-info-label">Resolution:</span> <span class="pdf-issue-resolution">${resolution}</span></div>` : ''}
                            ${parts ? `<div class="pdf-info-row"><span class="pdf-info-label">Parts:</span> <span class="pdf-info-value">${parts}</span></div>` : ''}
                        </div>
                    `;
                }
            }
            if (!issueFound) {
                issuesHTML = '<p class="pdf-no-data">No issues recorded</p>';
            }

            return `
                <div class="pdf-container">
                    <!-- Cover Page -->
                    <div class="pdf-cover-page">
                        <div class="pdf-cover-header">
                            <h1 class="pdf-cover-title">ZONEBRITE</h1>
                            <h2 class="pdf-cover-subtitle">SOLUTIONS</h2>
                            <p class="pdf-cover-tagline">Protecting What Matters Most</p>
                            <div class="pdf-cover-divider"></div>
                        </div>

                        <div class="pdf-cover-info-box">
                            <h3 class="pdf-cover-report-title">MONTHLY MAINTENANCE</h3>
                            <h3 class="pdf-cover-report-subtitle">REPORT</h3>
                        </div>

                        <div class="pdf-cover-client-box">
                            <div class="pdf-mb-4">
                                <p class="pdf-cover-client-label">CLIENT:</p>
                                <p class="pdf-cover-client-value">${data.clientName || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="pdf-cover-client-label">REPORT PERIOD:</p>
                                <p class="pdf-cover-client-value">${reportPeriod}</p>
                            </div>
                        </div>

                        <div class="pdf-cover-footer">
                            <p>Generated on: ${new Date().toLocaleDateString()}</p>
                            <p>Zonebrite Solutions | Phone: Contact for details</p>
                            <p>Email: info@zonebrite.com | www.zonebrite.com</p>
                        </div>
                    </div>

                    <!-- Content Pages -->
                    <div class="pdf-content">
                        <!-- Section 1: Report Information -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ“‹ REPORT INFORMATION</h3>
                            </div>
                            <div class="pdf-info-box pdf-space-y-2">
                                <p class="pdf-text-sm"><span class="pdf-info-label">Report Date:</span> ${data.reportDate || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Property Address:</span> ${data.propertyAddress || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Technician:</span> ${data.technicianName || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Service Date:</span> ${data.serviceDate || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Next Scheduled Maintenance:</span> ${data.nextMaintenance || 'N/A'}</p>
                            </div>
                        </div>

                        <!-- Section 2: System Health Overview -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ“Š SYSTEM HEALTH OVERVIEW</h3>
                            </div>
                            <div class="pdf-space-y-3">
                                <div class="pdf-flex-center pdf-flex-gap">
                                    <span class="pdf-info-label pdf-text-sm">Overall System Status:</span>
                                    <span class="${getStatusClass(data.systemStatus)}">${data.systemStatus || 'N/A'}</span>
                                </div>
                                <div class="pdf-flex-center pdf-flex-gap">
                                    <span class="pdf-info-label pdf-text-sm">Network Connectivity:</span>
                                    <span class="${getStatusClass(data.networkStatus)}">${data.networkStatus || 'N/A'}</span>
                                </div>

                                <div class="pdf-info-box pdf-space-y-2 pdf-mt-3">
                                    <p class="pdf-text-sm"><span class="pdf-info-label">Total Cameras:</span> ${data.totalCameras || '0'}</p>
                                    <p class="pdf-text-sm"><span class="pdf-info-label">Cameras Operational:</span> ${data.camerasOperational || '0'}</p>
                                    <p class="pdf-text-sm"><span class="pdf-info-label">Cameras Requiring Attention:</span> ${data.camerasAttention || '0'}</p>
                                </div>

                                <div class="pdf-info-box pdf-space-y-2 pdf-mt-3">
                                    <p class="pdf-text-sm"><span class="pdf-info-label">System Uptime:</span> ${data.uptime || '0'}%</p>
                                    <p class="pdf-text-sm"><span class="pdf-info-label">Recording Storage Used:</span> ${data.storageUsed || '0'}%</p>
                                    <p class="pdf-text-sm"><span class="pdf-info-label">Storage Days Remaining:</span> ${data.storageDays || '0'} days</p>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Maintenance Activities -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">âœ… MAINTENANCE ACTIVITIES COMPLETED</h3>
                            </div>
                            ${activities.length > 0 ? `
                                <div class="pdf-activities-grid">
                                    ${activities.map(activity => `
                                        <div class="pdf-activity-item">
                                            <div class="pdf-activity-checkmark">âœ“</div>
                                            <span class="pdf-activity-text">${activity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="pdf-no-data">No activities recorded</p>'}
                        </div>

                        <!-- Section 4: Individual Camera Status -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ“¹ INDIVIDUAL CAMERA STATUS</h3>
                            </div>
                            ${camerasHTML}
                        </div>

                        <!-- Section 5: Issues Identified & Resolved -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ”§ ISSUES IDENTIFIED & RESOLVED</h3>
                            </div>
                            ${issuesHTML}
                        </div>

                        <!-- Section 6: Recommendations -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ’¡ RECOMMENDATIONS</h3>
                            </div>
                            ${data.maintenanceRec || data.upgradeOpp || data.optimizationSug ? `
                                <div class="pdf-space-y-3">
                                    ${data.maintenanceRec ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">Maintenance Recommendations:</p><p class="pdf-text-dark pdf-text-sm">${data.maintenanceRec}</p></div>` : ''}
                                    ${data.upgradeOpp ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">Upgrade Opportunities:</p><p class="pdf-text-dark pdf-text-sm">${data.upgradeOpp}</p></div>` : ''}
                                    ${data.optimizationSug ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">System Optimization:</p><p class="pdf-text-dark pdf-text-sm">${data.optimizationSug}</p></div>` : ''}
                                    ${data.estimatedCost || data.priorityLevel ? `
                                        <div class="pdf-info-box pdf-space-y-2 pdf-mt-3">
                                            ${data.estimatedCost ? `<p class="pdf-text-sm"><span class="pdf-info-label">Estimated Cost:</span> ${data.estimatedCost}</p>` : ''}
                                            ${data.priorityLevel ? `<p class="pdf-text-sm"><span class="pdf-info-label">Priority Level:</span> ${data.priorityLevel}</p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : '<p class="pdf-no-data">No recommendations at this time</p>'}
                        </div>

                        <!-- Section 7: Storage & Recording -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ’¾ STORAGE & RECORDING DETAILS</h3>
                            </div>
                            <div class="pdf-info-box pdf-space-y-2 pdf-mb-3">
                                <p class="pdf-text-sm"><span class="pdf-info-label">Total Storage Capacity:</span> ${data.storageCapacity || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Current Storage Used:</span> ${data.storageCurrentlyUsed || 'N/A'}</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Recording Retention Period:</span> ${data.retentionPeriod || '0'} days</p>
                                <p class="pdf-text-sm"><span class="pdf-info-label">Video Quality Settings:</span> ${data.videoQuality || 'N/A'}</p>
                            </div>
                            <div class="pdf-flex-center pdf-flex-gap">
                                <span class="pdf-info-label pdf-text-sm">Backup Status:</span>
                                <span class="${getStatusClass(data.backupStatus)}">${data.backupStatus || 'N/A'}</span>
                            </div>
                        </div>

                        <!-- Section 8: System Updates -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ”„ SYSTEM UPDATES</h3>
                            </div>
                            ${data.firmwareVersion || data.softwareVersion || data.updatesApplied || data.updatesRecommended ? `
                                <div class="pdf-space-y-3">
                                    ${data.firmwareVersion || data.softwareVersion ? `
                                        <div class="pdf-info-box pdf-space-y-2">
                                            ${data.firmwareVersion ? `<p class="pdf-text-sm"><span class="pdf-info-label">Current Firmware Version:</span> ${data.firmwareVersion}</p>` : ''}
                                            ${data.softwareVersion ? `<p class="pdf-text-sm"><span class="pdf-info-label">Current Software Version:</span> ${data.softwareVersion}</p>` : ''}
                                        </div>
                                    ` : ''}
                                    ${data.updatesApplied ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">Updates Applied This Month:</p><p class="pdf-text-dark pdf-text-sm">${data.updatesApplied}</p></div>` : ''}
                                    ${data.updatesRecommended ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">Updates Recommended:</p><p class="pdf-text-dark pdf-text-sm">${data.updatesRecommended}</p></div>` : ''}
                                </div>
                            ` : '<p class="pdf-no-data">No updates information available</p>'}
                        </div>

                        <!-- Section 9: Summary -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">ðŸ“ SUMMARY</h3>
                            </div>
                            <div class="pdf-space-y-3">
                                <div>
                                    <p class="pdf-info-label pdf-text-sm pdf-mb-1">Overall Assessment:</p>
                                    <p class="pdf-text-dark pdf-text-sm">${data.overallAssessment || 'N/A'}</p>
                                </div>
                                ${data.criticalItems ? `
                                    <div class="pdf-critical-box">
                                        <p class="pdf-critical-title pdf-mb-2">âš  CRITICAL ITEMS REQUIRING IMMEDIATE ATTENTION:</p>
                                        <p class="pdf-text-dark pdf-text-sm">${data.criticalItems}</p>
                                    </div>
                                ` : ''}
                                ${data.focusAreas ? `
                                    <div>
                                        <p class="pdf-info-label pdf-text-sm pdf-mb-1">Next Month Focus Areas:</p>
                                        <p class="pdf-text-dark pdf-text-sm">${data.focusAreas}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Section 10: Sign-off -->
                        <div class="pdf-section">
                            <div class="pdf-section-header">
                                <h3 class="pdf-section-title">âœï¸ SIGN-OFF</h3>
                            </div>
                            <div class="pdf-signoff-box pdf-space-y-3">
                                <p class="pdf-text-sm"><span class="pdf-info-label">Technician Signature:</span> <span class="pdf-signoff-value">${data.techSignature || 'N/A'}</span></p>
                                ${data.clientAck ? `<p class="pdf-text-sm"><span class="pdf-info-label">Client Acknowledgment:</span> ${data.clientAck}</p>` : ''}
                                ${data.clientFeedback ? `<div><p class="pdf-info-label pdf-text-sm pdf-mb-1">Client Feedback:</p><p class="pdf-text-dark pdf-text-sm">${data.clientFeedback}</p></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
